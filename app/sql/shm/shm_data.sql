BEGIN;

INSERT INTO `users` VALUES
(1,0,'admin','0df78fa86a30eca0a918fdd21a94e238133ce7ab',0,NOW(),NULL,0,0,0.00,NULL,NULL,0,1,0,'Admin',0,0.00,NULL,NULL,NULL,NULL)
;

INSERT INTO `servers_groups` VALUES
(1,'Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è','mail','random',NULL),
(2,'VPN','ssh','random',NULL),
(3,'Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è','telegram','random',NULL)
;

INSERT INTO `services` VALUES
(1,'VPN (–†–æ—Å—Å–∏—è)',0.00,1.00,'vpn-russia','[]',NULL,0,NULL,NULL,1,0,NULL,0,NULL,0)
;

INSERT INTO `events` VALUES
(default,'UserService','User password reset','user_password_reset',1,'{\"category\": \"%\", \"template_id\": \"user_password_reset\"}'),
(default,'UserService','vpn create','create',2,'{\"category\": \"vpn-%\"}'),
(default,'UserService','vpn create mail','create',1,'{\"subject\": \"VPN —Å–æ–∑–¥–∞–Ω\", \"category\": \"vpn-%\", \"template_id\": \"vpn_created\"}'),
(default,'UserService','vpn remove','remove',0,'{\"category\": \"vpn-%\"}'),
(default,'UserService','vpn block','block',0,'{\"category\": \"vpn-%\"}'),
(default,'UserService','vpn activate','activate',0,'{\"category\": \"vpn-%\"}')
;

INSERT INTO `templates` VALUES
('vpn_created','–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ.\n\n–í–∞—à VPN –∫–ª—é—á —Å–æ–∑–¥–∞–Ω.\n\n–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å QR –∫–æ–¥ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –º–æ–∂–Ω–æ –∑–¥–µ—Å—å: \n{{ config.cli.url }}/shm/v1/storage/manage/vpn{{ us.id }}?format=qrcode\n\n–°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª –∫–ª—é—á–∞ –º–æ–∂–Ω–æ –∑–¥–µ—Å—å: \n{{ config.cli.url }}/shm/v1/storage/manage/vpn{{ us.id }}?filename=vpn{{ us.id }}&format=other\n\n–£—Å–ª—É–≥–∞ –æ–ø–ª–∞—á–µ–Ω–∞ –¥–æ: {{ us.expire }}',NULL),
('forecast','–£–≤–∞–∂–∞–µ–º—ã–π {{ user.full_name }}\n\n–£–≤–µ–¥–æ–º–ª—è–µ–º –í–∞—Å –æ —Å—Ä–æ–∫–∞—Ö –¥–µ–π—Å—Ç–≤–∏—è —É—Å–ª—É–≥:\n\n{{ FOR item IN user.pays.forecast.items }}\n- –£—Å–ª—É–≥–∞: {{ item.name }}\n  –°—Ç–æ–∏–º–æ—Å—Ç—å: {{ item.total }} —Ä—É–±.\n  –ò—Å—Ç–µ–∫–∞–µ—Ç: {{ item.expire }}\n{{ END }}\n\n{{ IF user.pays.forecast.dept }}\n–ü–æ–≥–∞—à–µ–Ω–∏–µ –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç–∏: {{ user.pays.forecast.dept }} —Ä—É–±.\n{{ END }}\n\n–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ: {{ user.pays.forecast.total }} —Ä—É–±.\n\n–£—Å–ª—É–≥–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –±—É–¥—É—Ç –æ–ø–ª–∞—á–µ–Ω—ã –¥–æ —Å—Ä–æ–∫–∞ –∏—Ö –∏—Å—Ç–µ—á–µ–Ω–∏—è, –±—É–¥—É—Ç –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã.\n\n–ü–æ–¥—Ä–æ–±–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ –í–∞—à–∏–º —É—Å–ª—É–≥–∞–º –í—ã –º–æ–∂–µ—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤ –≤–∞—à–µ–º –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ: {{ config.api.url }}\n\n–≠—Ç–æ –ø–∏—Å—å–º–æ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –ï—Å–ª–∏ –æ–Ω–æ –ø–æ–ø–∞–ª–æ –∫ –í–∞–º –ø–æ –æ—à–∏–±–∫–µ,\n–ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–æ–æ–±—â–∏—Ç–µ –æ–± —ç—Ç–æ–º –Ω–∞–º: {{ config.mail.from }}',NULL),
('user_password_reset','–£–≤–∞–∂–∞–µ–º—ã–π –∫–ª–∏–µ–Ω—Ç.\n\n–í–∞—à –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å: {{ user.set_new_passwd }}\n\n–ê–¥—Ä–µ—Å –∫–∞–±–∏–Ω–µ—Ç–∞: {{ config.cli.url }}','{\"subject\": \"SHM - –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è\"}'),
('wg_manager','#!/bin/bash\n\nset -e\n\nEVENT=\"{{ event_name }}\"\nWG_MANAGER=\"/etc/wireguard/wg-manager.sh\"\nSESSION_ID=\"{{ user.gen_session.id }}\"\nAPI_URL=\"{{ config.api.url }}\"\n\n# We need the --fail-with-body option for curl.\n# It has been added since curl 7.76.0, but almost all Linux distributions do not support it yet.\n# If your distribution has an older version of curl, you can use it (just comment CURL_REPO)\nCURL_REPO=\"https://github.com/moparisthebest/static-curl/releases/download/v7.86.0/curl-amd64\"\nCURL=\"/opt/curl/curl-amd64\"\n#CURL=\"curl\"\n\necho \"EVENT=$EVENT\"\n\ncase $EVENT in\n    INIT)\n        SERVER_HOST=\"{{ server.settings.host_name }}\"\n        SERVER_INTERFACE=\"{{ server.settings.host_interface }}\"\n        if [ -z $SERVER_HOST ]; then\n            echo \"ERROR: set variable \'host_name\' to server settings\"\n            exit 1\n        fi\n\n        echo \"Check domain: $API_URL\"\n        HTTP_CODE=$(curl -s -o /dev/null -w \"%{http_code}\" $API_URL/shm/v1/test)\n        if [ $HTTP_CODE -ne \'200\' ]; then\n            echo \"ERROR: incorrect API URL: $API_URL\"\n            echo \"Got status: $HTTP_CODE\"\n            exit 1\n        fi\n\n        echo \"Install required packages\"\n        apt update\n        apt install -y \\\n            iproute2 \\\n            iptables \\\n            wireguard \\\n            wireguard-tools \\\n            qrencode \\\n            wget\n\n        if [[ $CURL_REPO && ! -f $CURL ]]; then\n            echo \"Install modern curl\"\n            mkdir -p /opt/curl\n            cd /opt/curl\n            wget $CURL_REPO\n            chmod 755 $CURL\n        fi\n\n        echo \"Download wg-manager.sh\"\n        cd /etc/wireguard\n        $CURL -s --fail-with-body https://danuk.github.io/wg-manager/wg-manager.sh > $WG_MANAGER\n\n        echo \"Init server\"\n        chmod 700 $WG_MANAGER\n        if [ $SERVER_INTERFACE ]; then\n            $WG_MANAGER -i -s $SERVER_HOST -I $SERVER_INTERFACE\n        else\n            $WG_MANAGER -i -s $SERVER_HOST\n        fi\n        ;;\n    CREATE)\n        echo \"Create new user\"\n        USER_CFG=$($WG_MANAGER -u \"{{ us.id }}\" -c -p)\n\n        echo \"Upload user key to SHM\"\n        $CURL -s --fail-with-body -XPUT \\\n            -H \"session-id: $SESSION_ID\" \\\n            -H \"Content-Type: text/plain\" \\\n            $API_URL/shm/v1/storage/manage/vpn{{ us.id }} \\\n            --data-binary \"$USER_CFG\"\n        echo \"done\"\n        ;;\n    ACTIVATE)\n        echo \"Activate user\"\n        $WG_MANAGER -u \"{{ us.id }}\" -U\n        echo \"done\"\n        ;;\n    BLOCK)\n        echo \"Block user\"\n        $WG_MANAGER -u \"{{ us.id }}\" -L\n        echo \"done\"\n        ;;\n    REMOVE)\n        echo \"Remove user\"\n        $WG_MANAGER -u \"{{ us.id }}\" -d\n\n        echo \"Remove user key from SHM\"\n        $CURL -s --fail-with-body -XDELETE \\\n            -H \"session-id: $SESSION_ID\" \\\n            $API_URL/shm/v1/storage/manage/vpn{{ us.id }}\n        echo \"done\"\n        ;;\n    *)\n        echo \"Unknown event: $EVENT. Exit.\"\n        exit 0\n        ;;\nesac\n\n\n',NULL),
('telegram_bot','<% SWITCH cmd %>\n<% CASE \'USER_NOT_FOUND\' %>\n{\n    \"sendMessage\": {\n        \"text\": \"–î–ª—è —Ä–∞–±–æ—Ç—ã —Å Telegram –±–æ—Ç–æ–º —É–∫–∞–∂–∏—Ç–µ _Telegram –ª–æ–≥–∏–Ω_ –≤ –ø—Ä–æ—Ñ–∏–ª–µ –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞.\\n\\n*Telegram –ª–æ–≥–∏–Ω*: {{ message.chat.username }}\\n\\n*–ö–∞–±–∏–Ω–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è*: {{ config.cli.url }}\"\n    }\n}\n<% CASE [\'/start\', \'/menu\'] %>\n{{ IF cmd == \'/menu\' }}\n{\n    \"deleteMessage\": { \"message_id\": {{ message.message_id }} }\n},\n{{ END }}\n{\n    \"sendMessage\": {\n        \"text\": \"–°–æ–∑–¥–∞–≤–∞–π—Ç–µ –∏ —É–ø—Ä–∞–≤–ª—è–π—Ç–µ —Å–≤–æ–∏–º–∏ VPN –∫–ª—é—á–∞–º–∏\",\n        \"reply_markup\": {\n            \"inline_keyboard\": [\n                [\n                    {\n                        \"text\": \"üí∞ –ë–∞–ª–∞–Ω—Å\",\n                        \"callback_data\": \"/balance\"\n                    }\n                ],\n                [\n                    {\n                        \"text\": \"üóù  –ö–ª—é—á–∏\",\n                        \"callback_data\": \"/list\"\n                    }\n                ]\n            ]\n        }\n    }\n}\n<% CASE \'/balance\' %>\n{\n    \"deleteMessage\": { \"message_id\": {{ message.message_id }} }\n},\n{\n    \"sendMessage\": {\n        \"text\": \"üí∞ *–ë–∞–ª–∞–Ω—Å*: {{ user.balance }}\\n\\n–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –æ–ø–ª–∞—Ç–∏—Ç—å: * {{ user.pays.forecast.total }}*\",\n        \"reply_markup\" : {\n            \"inline_keyboard\": [\n                [\n                    {\n                        \"text\": \"‚á¶ –ù–∞–∑–∞–¥\",\n                        \"callback_data\": \"/menu\"\n                    }\n                ]\n            ]\n        }\n    }\n}\n<% CASE \'/list\' %>\n{\n    \"deleteMessage\": { \"message_id\": {{ message.message_id }} }\n},\n{\n    \"sendMessage\": {\n        \"text\": \"üóù  –ö–ª—é—á–∏\",\n        \"reply_markup\" : {\n            \"inline_keyboard\": [\n                {{ FOR item IN ref(user.services.list_for_api( \'category\', \'%\' )) }}\n                {{ SWITCH item.status }}\n                  {{ CASE \'ACTIVE\' }}\n                  {{ status = \'‚úÖ\' }}\n                  {{ CASE \'BLOCK\' }}\n                  {{ status = \'‚ùå\' }}\n                  {{ CASE \'NOT PAID\' }}\n                  {{ status = \'üí∞\' }}\n                  {{ CASE }}\n                  {{ status = \'‚è≥\' }}\n                {{ END }}\n                [\n                    {\n                        \"text\": \"{{ status }} - {{ item.name }}\",\n                        \"callback_data\": \"/service {{ item.user_service_id }}\"\n                    }\n                ],\n                {{ END }}\n                [\n                    {\n                        \"text\": \"‚á¶ –ù–∞–∑–∞–¥\",\n                        \"callback_data\": \"/menu\"\n                    }\n                ]\n            ]\n        }\n    }\n}\n<% CASE \'/service\' %>\n{{ us = user.services.list_for_api( \'usi\', args.0 ) }}\n{\n    \"deleteMessage\": { \"message_id\": {{ message.message_id }} }\n},\n{\n    \"sendMessage\": {\n        \"text\": \"*–ö–ª—é—á*: {{ us.name }}\\n\\n*–û–ø–ª–∞—á–µ–Ω –¥–æ*: {{ us.expire }}\\n\\n*–°—Ç–∞—Ç—É—Å*: {{ us.status }}\",\n        \"reply_markup\" : {\n            \"inline_keyboard\": [\n                {{ IF us.status == \'ACTIVE\' }}\n                [\n                    {\n                        \"text\": \"üóù  –°–∫–∞—á–∞—Ç—å –∫–ª—é—á\",\n                        \"callback_data\": \"/download_qr {{ args.0 }}\"\n                    },\n                    {\n                        \"text\": \"üëÄ –ü–æ–∫–∞–∑–∞—Ç—å QR –∫–æ–¥\",\n                        \"callback_data\": \"/show_qr {{ args.0 }}\"\n                    }\n                ],\n                {{ END }}\n                [\n                    {\n                        \"text\": \"‚á¶ –ù–∞–∑–∞–¥\",\n                        \"callback_data\": \"/list\"\n                    }\n                ]\n            ]\n        }\n    }\n}\n<% CASE \'/download_qr\' %>\n{\n    \"uploadDocumentFromStorage\": {\n        \"name\": \"vpn{{ args.0 }}\",\n        \"filename\": \"vpn{{ args.0 }}.txt\"\n    }\n}\n<% CASE \'/show_qr\' %>\n{\n    \"uploadPhotoFromStorage\": {\n        \"name\": \"vpn{{ args.0 }}\",\n        \"format\": \"qr_code_png\"\n    }\n}\n<% END %>\n\n',NULL),
('yoomoney_template','<iframe src=\"https://yoomoney.ru/quickpay/shop-widget?writer=seller&targets=%D0%9E%D0%BF%D0%BB%D0%B0%D1%82%D0%B0%20%D0%BF%D0%BE%20%D0%B4%D0%BE%D0%B3%D0%BE%D0%B2%D0%BE%D1%80%D1%83%20{{ user.id }}&targets-hint=&default-sum=100&label={{ user.id }}&button-text=12&payment-type-choice=on&hint=&successURL=&quickpay=shop&account={{ config.pay_systems.yoomoney.account }}\" width=\"100%\" height=\"198\" frameborder=\"0\" allowtransparency=\"true\" scrolling=\"no\"></iframe>',NULL)
;

INSERT INTO `config` VALUES
("_shm", '{"version":"0.0.3"}'),
('billing','{"type": "Simpler", "partner": {"income_percent": 0}}'),
("company", '{"name":"My Company LTD"}'),
("telegram", '{"token":""}'),
("api",     '{"url":"http://127.0.0.1:8081"}'),
("cli",     '{"url":"http://127.0.0.1:8082"}'),
("pay_systems",'{"manual":{"name":"–ü–ª–∞—Ç–µ–∂","show_for_client":false},"yoomoney":{"name":"–ÆMoney","account":"000000000000000","secret":"","template_id":"yoomoney_template","show_for_client":true}}'),
("mail",    '{"from":"mail@domain.ru"}')
;

INSERT INTO `spool` (id,status,user_id,event) VALUES
(default,'NEW',1,'{"title":"prolongate services","kind":"Jobs","method":"job_prolongate","period":"600"}'),
(default,'PAUSED',1,'{"title":"cleanup services","kind":"Jobs","method":"job_cleanup","period":"86400","settings":{"days":10}}'),
(default,'PAUSED',1,'{"title":"send forecasts","kind":"Jobs","method":"job_make_forecasts","period":"86400","settings":{"server_gid":1,"template_id": "forecast"}}')
;

COMMIT;

