name: Build and Push Docker Images

on:
  push:
    tags:
      - '*'

env:
  REGISTRY: docker.io
  IMAGE_NAME: danuk/shm

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch full history for git describe

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Extract version info
      id: version
      run: |
        # Get the tag name
        TAG=${GITHUB_REF#refs/tags/}
        echo "tag=${TAG}" >> $GITHUB_OUTPUT

        # Get minor version (1.2 from 1.2.3)
        VERSION_MINOR=$(echo $TAG | cut -d '.' -f 1,2)
        echo "minor=${VERSION_MINOR}" >> $GITHUB_OUTPUT

        # Get git revision
        REV=$(git rev-parse --short HEAD)
        echo "rev=${REV}" >> $GITHUB_OUTPUT

        # Create version string for app/version
        VERSION_STRING="${TAG}-${REV}"
        echo "version_string=${VERSION_STRING}" >> $GITHUB_OUTPUT

        # Check if tag is from master branch - more reliable method
        IS_MASTER="false"
        if git merge-base --is-ancestor HEAD origin/master 2>/dev/null; then
          # Tag is an ancestor of master
          BRANCH=$(git branch -r --contains HEAD | grep -E 'origin/master$' | head -n1)
          if [ -n "$BRANCH" ]; then
            IS_MASTER="true"
            echo "Tag is from master branch - will push 'latest' tag"
          fi
        fi

        if [ "$IS_MASTER" = "false" ]; then
          echo "Tag is NOT from master branch - will NOT push 'latest' tag"
        fi

        echo "push_latest=${IS_MASTER}" >> $GITHUB_OUTPUT
        echo "Building version: ${VERSION_STRING}"

    - name: Create version.json
      run: |
        cat > app/version.json << EOF
        {
            "version": "${{ steps.version.outputs.version_string }}",
            "commitSha": "${{ github.sha }}",
            "releaseUrl": "https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }}"
        }
        EOF
        cat app/version.json

    - name: Build and push API image
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64,linux/arm64
        push: true
        target: api
        tags: |
          ${{ env.IMAGE_NAME }}-api:${{ steps.version.outputs.tag }}
          ${{ steps.version.outputs.push_latest == 'true' && format('{0}-api:{1}', env.IMAGE_NAME, steps.version.outputs.minor) || format('{0}-api:skip-minor-{1}', env.IMAGE_NAME, steps.version.outputs.rev) }}
          ${{ steps.version.outputs.push_latest == 'true' && format('{0}-api:latest', env.IMAGE_NAME) || format('{0}-api:skip-latest-{1}', env.IMAGE_NAME, steps.version.outputs.rev) }}

    - name: Build and push Core image
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64,linux/arm64
        push: true
        target: core
        tags: |
          ${{ env.IMAGE_NAME }}-core:${{ steps.version.outputs.tag }}
          ${{ steps.version.outputs.push_latest == 'true' && format('{0}-core:{1}', env.IMAGE_NAME, steps.version.outputs.minor) || format('{0}-core:skip-minor-{1}', env.IMAGE_NAME, steps.version.outputs.rev) }}
          ${{ steps.version.outputs.push_latest == 'true' && format('{0}-core:latest', env.IMAGE_NAME) || format('{0}-core:skip-latest-{1}', env.IMAGE_NAME, steps.version.outputs.rev) }}

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.tag }}
        name: Release ${{ steps.version.outputs.tag }}
        generate_release_notes: true
        body: |
          ## Docker Images Built

          ### API Image
          - `${{ env.IMAGE_NAME }}-api:${{ steps.version.outputs.tag }}`${{ steps.version.outputs.push_latest == 'true' && format('\n          - `{0}-api:{1}`', env.IMAGE_NAME, steps.version.outputs.minor) || '' }}${{ steps.version.outputs.push_latest == 'true' && format('\n          - `{0}-api:latest`', env.IMAGE_NAME) || '' }}

          ### Core Image
          - `${{ env.IMAGE_NAME }}-core:${{ steps.version.outputs.tag }}`${{ steps.version.outputs.push_latest == 'true' && format('\n          - `{0}-core:{1}`', env.IMAGE_NAME, steps.version.outputs.minor) || '' }}${{ steps.version.outputs.push_latest == 'true' && format('\n          - `{0}-core:latest`', env.IMAGE_NAME) || '' }}

          **Version:** `${{ steps.version.outputs.version_string }}`
          **Git Revision:** `${{ steps.version.outputs.rev }}`
          ${{ steps.version.outputs.push_latest != 'true' && '**Note:** This release is from a non-master branch. Minor version and latest tags were not created.' || '' }}

          ## What's Changed

          *Changelog will be generated automatically below based on commits and pull requests.*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}