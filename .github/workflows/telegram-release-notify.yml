name: 'Telegram Release Notification'

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag_name:
        description: '–¢–µ–≥ —Ä–µ–ª–∏–∑–∞'
        required: true
        default: 'v1.0.0'
      release_name:
        description: '–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–ª–∏–∑–∞'
        required: true
        default: '–†–µ–ª–∏–∑ v1.0.0'
      body:
        description: '–û–ø–∏—Å–∞–Ω–∏–µ —Ä–µ–ª–∏–∑–∞ (changelog)'
        required: true
        default: |
          ## –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
          * –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è 1
          * –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è 2
          * –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—à–∏–±–æ–∫

jobs:
  notify-telegram:
    runs-on: ubuntu-latest
    steps:
      - name: –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v4

      - name: –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ä–µ–ª–∏–∑–µ
        id: release_info
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            echo "tag_name=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
            echo "name=${{ github.event.release.name }}" >> $GITHUB_OUTPUT
            echo "prerelease=${{ github.event.release.prerelease }}" >> $GITHUB_OUTPUT
            # Escape newlines and special characters in body
            BODY=$(echo '${{ github.event.release.body }}' | sed ':a;N;$!ba;s/\n/\\n/g' | sed 's/"/\\"/g')
            echo "body=$BODY" >> $GITHUB_OUTPUT
          else
            echo "tag_name=${{ github.event.inputs.tag_name }}" >> $GITHUB_OUTPUT
            echo "name=${{ github.event.inputs.release_name }}" >> $GITHUB_OUTPUT
            echo "prerelease=false" >> $GITHUB_OUTPUT
            BODY=$(echo '${{ github.event.inputs.body }}' | sed ':a;N;$!ba;s/\n/\\n/g' | sed 's/"/\\"/g')
            echo "body=$BODY" >> $GITHUB_OUTPUT
          fi

      - name: –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è Telegram
        id: format_message
        run: |
          TAG_NAME="${{ steps.release_info.outputs.tag_name }}"
          RELEASE_NAME="${{ steps.release_info.outputs.name }}"
          PRERELEASE="${{ steps.release_info.outputs.prerelease }}"
          BODY="${{ steps.release_info.outputs.body }}"
          REPO_NAME="${{ github.repository }}"
          REPO_URL="https://github.com/${{ github.repository }}"

          # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ —Ä–µ–ª–∏–∑–∞ –∏ —ç–º–æ–¥–∑–∏
          if [ "$PRERELEASE" = "true" ]; then
            EMOJI="üß™"
            RELEASE_TYPE="–ü—Ä–µ–¥-—Ä–µ–ª–∏–∑"
          else
            EMOJI="üöÄ"
            RELEASE_TYPE="–†–µ–ª–∏–∑"
          fi

          # –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–º–º–∏—Ç–æ–≤ –¥–ª—è —Ä–µ–ª–∏–∑–∞
          echo "–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∫–æ–º–º–∏—Ç–æ–≤..."

          # –ü–æ–ª—É—á–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–µ–≥
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -n "$PREVIOUS_TAG" ]; then
            # –ü–æ–ª—É—á–∞–µ–º –∫–æ–º–º–∏—Ç—ã –º–µ–∂–¥—É –ø—Ä–µ–¥—ã–¥—É—â–∏–º –∏ —Ç–µ–∫—É—â–∏–º —Ç–µ–≥–æ–º
            COMMITS=$(git log --pretty=format:"‚Ä¢ %s" ${PREVIOUS_TAG}..HEAD 2>/dev/null || echo "")
          else
            # –ï—Å–ª–∏ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Ç–µ–≥–∞ –Ω–µ—Ç, –ø–æ–ª—É—á–∞–µ–º –≤—Å–µ –∫–æ–º–º–∏—Ç—ã
            COMMITS=$(git log --pretty=format:"‚Ä¢ %s" HEAD 2>/dev/null || echo "")
          fi

          # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–º–∏—Ç–æ–≤ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 100)
          if [ -n "$COMMITS" ]; then
            COMMITS=$(echo "$COMMITS" | head -100)
            COMMITS_SECTION="$COMMITS"
          else
            COMMITS_SECTION="–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –∫–æ–¥–µ"
          fi

          # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–∏—Å–ø–æ–ª—å–∑—É–µ–º plain text –±–µ–∑ Markdown)
          MESSAGE="${EMOJI} ${RELEASE_TYPE} ${TAG_NAME}\n\nüì¶ –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: ${REPO_NAME}\n\nüìã Changelog:\n${COMMITS_SECTION}\n\nüîó –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–ª–∏–∑: ${REPO_URL}/releases/tag/${TAG_NAME}"

          # Escape the message for JSON
          MESSAGE=$(echo "$MESSAGE" | sed ':a;N;$!ba;s/\n/\\n/g' | sed 's/"/\\"/g')
          echo "message=$MESSAGE" >> $GITHUB_OUTPUT

      - name: –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -z "$TELEGRAM_BOT_TOKEN" ]; then
            echo "‚ùå –°–µ–∫—Ä–µ—Ç TELEGRAM_BOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω"
            echo "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –¥–æ–±–∞–≤—å—Ç–µ —Ç–æ–∫–µ–Ω Telegram –±–æ—Ç–∞ –≤ —Å–µ–∫—Ä–µ—Ç—ã —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è"
            exit 1
          fi

          if [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "‚ùå –°–µ–∫—Ä–µ—Ç TELEGRAM_CHAT_ID –Ω–µ –Ω–∞–π–¥–µ–Ω"
            echo "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –¥–æ–±–∞–≤—å—Ç–µ ID —á–∞—Ç–∞/–∫–∞–Ω–∞–ª–∞ Telegram –≤ —Å–µ–∫—Ä–µ—Ç—ã —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è"
            exit 1
          fi

          MESSAGE="${{ steps.format_message.outputs.message }}"

          # –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram
          RESPONSE=$(curl -s -X POST \
            "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{
              \"chat_id\": \"${TELEGRAM_CHAT_ID}\",
              \"text\": \"${MESSAGE}\",
              \"disable_web_page_preview\": false
            }")

          # –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
          if echo "$RESPONSE" | grep -q '"ok":true'; then
            echo "‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ä–µ–ª–∏–∑–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram!"
            echo "–û—Ç–≤–µ—Ç: $RESPONSE"
          else
            echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram"
            echo "–û—Ç–≤–µ—Ç: $RESPONSE"
            exit 1
          fi

      - name: –¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (—Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä—É—á–Ω–æ–º –∑–∞–ø—É—Å–∫–µ)
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "üß™ –≠—Ç–æ –±—ã–ª —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫, –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–π –≤—Ä—É—á–Ω—É—é"
          echo "–í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ —ç—Ç–æ—Ç workflow –±—É–¥–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ä–µ–ª–∏–∑–∞"