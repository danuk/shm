name: 'Telegram Release Notification'

on:
  workflow_run:
    workflows: ["Build and Push Docker Images"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      tag_name:
        description: '–¢–µ–≥ —Ä–µ–ª–∏–∑–∞'
        required: true
        default: 'v1.0.0'
      release_name:
        description: '–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–ª–∏–∑–∞'
        required: true
        default: '–†–µ–ª–∏–∑ v1.0.0'
      body:
        description: '–û–ø–∏—Å–∞–Ω–∏–µ —Ä–µ–ª–∏–∑–∞ (changelog)'
        required: true
        default: |
          ## –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
          * –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è 1
          * –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è 2
          * –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—à–∏–±–æ–∫

jobs:
  notify-telegram:
    runs-on: ubuntu-latest
    # –ó–∞–ø—É—Å–∫–∞—Ç—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ workflow_run –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —É—Å–ø–µ—à–Ω–æ –∏–ª–∏ —ç—Ç–æ —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    steps:
      - name: –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_branch || github.ref }}

      - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ª–æ–≤–∏–π –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        id: check_conditions
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "should_notify=true" >> $GITHUB_OUTPUT
            echo "is_manual=true" >> $GITHUB_OUTPUT
            echo "‚úÖ –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ - –æ—Ç–ø—Ä–∞–≤–∏–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ"
          else
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–µ–≥ –±—ã–ª —Å–æ–∑–¥–∞–Ω –∏–∑ master –≤–µ—Ç–∫–∏
            # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ç–µ–≥
            TAG_NAME=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

            if [ -z "$TAG_NAME" ]; then
              echo "should_notify=false" >> $GITHUB_OUTPUT
              echo "is_manual=false" >> $GITHUB_OUTPUT
              echo "‚è≠Ô∏è –¢–µ–≥ –Ω–µ –Ω–∞–π–¥–µ–Ω - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ"
              exit 0
            fi

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å –∫–∞–∫–æ–π –≤–µ—Ç–∫–∏ –±—ã–ª —Å–æ–∑–¥–∞–Ω —ç—Ç–æ—Ç —Ç–µ–≥
            BRANCHES=$(git branch -r --contains "tags/${TAG_NAME}" | grep -v HEAD | sed 's/.*origin\///' | tr -d ' ')

            echo "–¢–µ–≥ ${TAG_NAME} —Å–æ–¥–µ—Ä–∂–∏—Ç—Å—è –≤ –≤–µ—Ç–∫–∞—Ö: ${BRANCHES}"

            if echo "$BRANCHES" | grep -q "^master$"; then
              echo "should_notify=true" >> $GITHUB_OUTPUT
              echo "is_manual=false" >> $GITHUB_OUTPUT
              echo "tag_name=${TAG_NAME}" >> $GITHUB_OUTPUT
              echo "‚úÖ –¢–µ–≥ ${TAG_NAME} —Å–æ–∑–¥–∞–Ω –∏–∑ master –≤–µ—Ç–∫–∏ - –æ—Ç–ø—Ä–∞–≤–∏–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ"
            else
              echo "should_notify=false" >> $GITHUB_OUTPUT
              echo "is_manual=false" >> $GITHUB_OUTPUT
              echo "‚è≠Ô∏è –¢–µ–≥ ${TAG_NAME} –ù–ï –∏–∑ master –≤–µ—Ç–∫–∏ (${BRANCHES}) - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ"
            fi
          fi

      - name: –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ä–µ–ª–∏–∑–µ
        id: release_info
        if: steps.check_conditions.outputs.should_notify == 'true'
        run: |
          if [ "${{ steps.check_conditions.outputs.is_manual }}" = "true" ]; then
            echo "tag_name=${{ github.event.inputs.tag_name }}" >> $GITHUB_OUTPUT
            echo "name=${{ github.event.inputs.release_name }}" >> $GITHUB_OUTPUT
            echo "prerelease=false" >> $GITHUB_OUTPUT
            BODY=$(echo '${{ github.event.inputs.body }}' | sed ':a;N;$!ba;s/\n/\\n/g' | sed 's/"/\\"/g')
            echo "body=$BODY" >> $GITHUB_OUTPUT
          else
            # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–≥ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —à–∞–≥–∞ –∏–ª–∏ –Ω–∞–ø—Ä—è–º—É—é
            TAG_NAME="${{ steps.check_conditions.outputs.tag_name }}"
            if [ -z "$TAG_NAME" ]; then
              TAG_NAME=$(git describe --tags --abbrev=0 2>/dev/null || echo "unknown")
            fi
            echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
            echo "name=Release $TAG_NAME" >> $GITHUB_OUTPUT
            echo "prerelease=false" >> $GITHUB_OUTPUT
            echo "body=–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–ª–∏–∑ –∏–∑ master –≤–µ—Ç–∫–∏" >> $GITHUB_OUTPUT
          fi

      - name: –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è Telegram
        id: format_message
        if: steps.check_conditions.outputs.should_notify == 'true'
        run: |
          TAG_NAME="${{ steps.release_info.outputs.tag_name }}"
          RELEASE_NAME="${{ steps.release_info.outputs.name }}"
          PRERELEASE="${{ steps.release_info.outputs.prerelease }}"
          BODY="${{ steps.release_info.outputs.body }}"
          REPO_NAME="${{ github.repository }}"
          REPO_URL="https://github.com/${{ github.repository }}"

          # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ —Ä–µ–ª–∏–∑–∞ –∏ —ç–º–æ–¥–∑–∏
          if [ "$PRERELEASE" = "true" ]; then
            EMOJI="üß™"
            RELEASE_TYPE="–ü—Ä–µ–¥-—Ä–µ–ª–∏–∑"
          else
            EMOJI="üöÄ"
            RELEASE_TYPE="–†–µ–ª–∏–∑"
          fi

          # –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–º–º–∏—Ç–æ–≤ –¥–ª—è —Ä–µ–ª–∏–∑–∞
          echo "–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∫–æ–º–º–∏—Ç–æ–≤..."

          # –ü–æ–ª—É—á–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–µ–≥
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -n "$PREVIOUS_TAG" ]; then
            # –ü–æ–ª—É—á–∞–µ–º –∫–æ–º–º–∏—Ç—ã –º–µ–∂–¥—É –ø—Ä–µ–¥—ã–¥—É—â–∏–º –∏ —Ç–µ–∫—É—â–∏–º —Ç–µ–≥–æ–º
            COMMITS=$(git log --pretty=format:"‚Ä¢ %s" ${PREVIOUS_TAG}..HEAD 2>/dev/null || echo "")
          else
            # –ï—Å–ª–∏ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Ç–µ–≥–∞ –Ω–µ—Ç, –ø–æ–ª—É—á–∞–µ–º –≤—Å–µ –∫–æ–º–º–∏—Ç—ã
            COMMITS=$(git log --pretty=format:"‚Ä¢ %s" HEAD 2>/dev/null || echo "")
          fi

          # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–º–∏—Ç–æ–≤ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 100)
          if [ -n "$COMMITS" ]; then
            # –ò—Å–∫–ª—é—á–∞–µ–º —Å—Ç—Ä–æ–∫–∏, –Ω–∞—á–∏–Ω–∞—é—â–∏–µ—Å—è –Ω–∞ 'Merge pull request'
            COMMITS=$(echo "$COMMITS" | grep -v '^‚Ä¢ Merge pull request')
            COMMITS=$(echo "$COMMITS" | head -100)
            COMMITS_SECTION="$COMMITS"
          else
            COMMITS_SECTION="–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –∫–æ–¥–µ"
          fi

          # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–∏—Å–ø–æ–ª—å–∑—É–µ–º plain text –±–µ–∑ Markdown)
          printf '%s\n\n%s\n\n%s\n%s\n\n%s' \
            "${EMOJI} ${RELEASE_TYPE} ${TAG_NAME}" \
            "üì¶ –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: ${REPO_NAME}" \
            "üìã Changelog:" \
            "${COMMITS_SECTION}" \
            "üîó –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–ª–∏–∑: ${REPO_URL}/releases/tag/${TAG_NAME}" \
            > /tmp/telegram_message.txt

          # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É —Å–æ–æ–±—â–µ–Ω–∏—è
          echo "message_file=/tmp/telegram_message.txt" >> $GITHUB_OUTPUT

      - name: –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram
        if: steps.check_conditions.outputs.should_notify == 'true'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_THREAD_ID: ${{ secrets.TELEGRAM_THREAD_ID }}
        run: |
          if [ -z "$TELEGRAM_BOT_TOKEN" ]; then
            echo "‚ùå –°–µ–∫—Ä–µ—Ç TELEGRAM_BOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω"
            echo "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –¥–æ–±–∞–≤—å—Ç–µ —Ç–æ–∫–µ–Ω Telegram –±–æ—Ç–∞ –≤ —Å–µ–∫—Ä–µ—Ç—ã —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è"
            exit 1
          fi

          if [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "‚ùå –°–µ–∫—Ä–µ—Ç TELEGRAM_CHAT_ID –Ω–µ –Ω–∞–π–¥–µ–Ω"
            echo "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –¥–æ–±–∞–≤—å—Ç–µ ID —á–∞—Ç–∞/–∫–∞–Ω–∞–ª–∞ Telegram –≤ —Å–µ–∫—Ä–µ—Ç—ã —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è"
            exit 1
          fi

          MESSAGE_FILE="${{ steps.format_message.outputs.message_file }}"

          # –°–æ–∑–¥–∞–µ–º JSON payload —Å –ø–æ–º–æ—â—å—é jq –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
          PAYLOAD=$(jq -n \
            --arg chat_id "${TELEGRAM_CHAT_ID}" \
            --arg thread_id "${TELEGRAM_THREAD_ID}" \
            --rawfile text "$MESSAGE_FILE" \
            '{
              chat_id: $chat_id,
              message_thread_id: ($thread_id // null),
              text: $text,
              disable_notification: true,
              disable_web_page_preview: true
            }')

          # –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram
          RESPONSE=$(curl -s -X POST \
            "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD")

          # –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
          if echo "$RESPONSE" | grep -q '"ok":true'; then
            echo "‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ä–µ–ª–∏–∑–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram!"
            echo "–û—Ç–≤–µ—Ç: $RESPONSE"
          else
            echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram"
            echo "–û—Ç–≤–µ—Ç: $RESPONSE"
            exit 1
          fi

      - name: –¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (—Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä—É—á–Ω–æ–º –∑–∞–ø—É—Å–∫–µ)
        if: steps.check_conditions.outputs.is_manual == 'true'
        run: |
          echo "üß™ –≠—Ç–æ –±—ã–ª —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫, –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–π –≤—Ä—É—á–Ω—É—é"
          echo "–í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ —ç—Ç–æ—Ç workflow –±—É–¥–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å–ª–µ —Å–±–æ—Ä–∫–∏ —Ä–µ–ª–∏–∑–∞ –∏–∑ master –≤–µ—Ç–∫–∏"

      - name: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–ø—É—Å–∫–µ
        if: steps.check_conditions.outputs.should_notify == 'false'
        run: |
          echo "‚è≠Ô∏è –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–æ–ø—É—â–µ–Ω–æ - —Ä–µ–ª–∏–∑ –Ω–µ –∏–∑ master –≤–µ—Ç–∫–∏"
          echo "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–µ–ª–∏–∑–æ–≤ –∏–∑ master –≤–µ—Ç–∫–∏ (—Å —Ç–µ–≥–æ–º latest)"
