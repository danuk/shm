user nginx;
worker_processes auto;
pid /run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    set_real_ip_from 172.16.0.0/12;
    set_real_ip_from 192.168.0.0/16;
    set_real_ip_from 10.0.0.0/8;
    real_ip_header X-Forwarded-For;
    real_ip_recursive on;

    geo $limit_ip {
        default $binary_remote_addr;
        127.0.0.0/8 "";
        10.0.0.0/8 "";
        172.16.0.0/12 "";
        192.168.0.0/16 "";
    }

    limit_req_zone $limit_ip zone=perip:10m rate=1r/s;

    limit_req_status 429;
    limit_req_log_level warn;

    log_format json_combined escape=json '{'
        '"time": "$time_iso8601",'
        '"remote_addr": "$remote_addr",'
        '"real_ip": "$realip_remote_addr",'
        '"method": "$request_method",'
        '"uri": "$request_uri",'
        '"status": $status,'
        '"body_bytes_sent": $body_bytes_sent,'
        '"request_time": $request_time,'
        '"user_agent": "$http_user_agent",'
        '"forwarded_for": "$http_x_forwarded_for"'
    '}';

    access_log /var/log/nginx/access.log json_combined;
    error_log /var/log/nginx/error.log error;

    sendfile on;
    keepalive_timeout 65;

    server {
        listen 80 default_server;
        listen [::]:80 default_server;
        server_name _;
        root /app/public_html/;

        charset utf8;
        index index.html;

        limit_req zone=perip burst=5 nodelay;

        error_page 403 /403.html;
        error_page 404 /404.html;
        error_page 429 @rate_limit_error;

        resolver 127.0.0.11 valid=3s ipv6=off;

        location = /shm/healthcheck.cgi {
            access_log off;
            include /etc/nginx/uwsgi_params;

            uwsgi_param PERL5LIB "/app/lib:/app/conf";
            uwsgi_param TRUSTED_IPS "TRUSTED_IPS_PLACEHOLDER";

            uwsgi_modifier1 9;
            uwsgi_pass core:9082;
        }

        location / {
            include /etc/nginx/uwsgi_params;

            proxy_read_timeout 300s;
            uwsgi_read_timeout 300s;
            uwsgi_param PERL5LIB "/app/lib:/app/conf";
            uwsgi_param TRUSTED_IPS "TRUSTED_IPS_PLACEHOLDER";
            uwsgi_pass_header Authorization;

            uwsgi_modifier1 9;
            uwsgi_pass core:9082;
        }

        location @rate_limit_error {
            internal;
            default_type application/json;
            return 429 '{"status": 429, "error": "Too Many Requests"}';
        }
    }
}

